<br />
<h1><%= @game.name %> </h1>
<div>
  white player: <%= (@game.white_player_id == nil) ? '...waiting to join' : User.find(@game.white_player_id).email %>
</div>
<div>
  black player: <%= (@game.black_player_id == nil) ? '...waiting to join' : User.find(@game.black_player_id).email %>
</div>

<div class="chessboard">

  <% for y in 0..7 do %>
    <% for x in 0..7 do %>

      <% color = "" %>
      <% if (y % 2 == 0) %>
        <% color = (x % 2 == 0) ? "white" : "black" %>
      <% else %>
        <% color = (x % 2 == 0) ? "black" : "white" %>
      <% end %>

      <div class='droppable <%= color %>' data-x="<%= x %>" data-y="<%= y %>">
        <% if gamepiece = @pieces.where("(x_position = ? AND y_position = ?)", x, y).first %>
            <% if selected_piece = @pieces.where("(selected = ?)", true).first %>
              <div class="piece">
                <%= gamepiece.type %> <%= gamepiece.color %> user id: <%= gamepiece.user_id %> <%= gamepiece.selected %>
              </div>
            <% else %>
              <div class="piece" data-id="<%= gamepiece.id %>" data-x="<%= x %>" data-y="<%= y %>">
                <%= link_to gamepiece.type, piece_path(gamepiece, :x => x, :y => y), :method => :patch %>
                <%= gamepiece.color %> user id: <%= gamepiece.user_id %> <%= gamepiece.selected %>
              </div>
            <% end %>
        <% else %>

          <% if selected_piece = @pieces.where("(selected = ?)", true).first %>
            <%= link_to 'space', piece_path(selected_piece, :x => x, :y => y), :method => :patch %>
          <% end %>
        <% end %>
      </div>

    <% end %>
  <% end %>

</div>

<!-- ///drag-drop unimplemented -->

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.1/jquery.min.js" type="text/javascript"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.1/jquery-ui.min.js"></script>

<script>
  $(document).ready(function () {

    $(".draggable").draggable({
      helper: "clone",
    });
    $(".droppable").droppable({

      drop: function( event, ui) {

        var id = ui.draggable.data('id')
        var x = $(this).data('x')
        var y = $(this).data('y')

        console.log("drop it");
        console.log(id, x, y);

        $.ajax({
          type: 'PUT',
           url: '/pieces/' + id,
           dataType: 'json',
           data: { id: id, x_position: x, y_position: y },
           success: function(data){
             location.reload();
          }
        });
      }
    });
  });
</script>
